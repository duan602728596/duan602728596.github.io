<!DOCTYPE html><html lang="zh-cmn-Hans"><head><meta charSet="utf-8"/><meta name="renderer" content="webkit"/><meta name="viewport" content="width=device-width, initial-scale=1"/><meta http-equiv="Window-target" content="_top"/><meta name="author" content="段昊辰, duanhaochen@126.com"/><meta name="copyright" content="段昊辰, duanhaochen@126.com"/><title>用JS实现多个任务并行执行的队列</title><meta name="keywords" content="前端, js, javascript, typescript, node"/><meta name="description" content="用JS实现多个任务并行执行的队列"/><meta name="next-head-count" content="9"/><link rel="icon" href="/images/favicon.jpg" type="image/jpeg"/><link rel="stylesheet" href="/styles/github.css"/><script src="/scripts/live2dcubismcore.min.js"></script><link rel="preload" href="/_next/static/css/87a20ae219495992.css" as="style"/><link rel="stylesheet" href="/_next/static/css/87a20ae219495992.css" data-n-g=""/><link rel="preload" href="/_next/static/css/ad5cb8c4b09bea9d.css" as="style"/><link rel="stylesheet" href="/_next/static/css/ad5cb8c4b09bea9d.css" data-n-p=""/><link rel="preload" href="/_next/static/css/18922162af13363b.css" as="style"/><link rel="stylesheet" href="/_next/static/css/18922162af13363b.css" data-n-p=""/><link rel="preload" href="/_next/static/css/efb6aa914c1f8d63.css" as="style"/><link rel="stylesheet" href="/_next/static/css/efb6aa914c1f8d63.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script src="/_next/static/chunks/webpack-eb25b9c801229373.js" defer=""></script><script src="/_next/static/chunks/framework-4ed89e9640adfb9e.js" defer=""></script><script src="/_next/static/chunks/main-846684b14167b237.js" defer=""></script><script src="/_next/static/chunks/pages/_app-7862fb1b49f88f02.js" defer=""></script><script src="/_next/static/chunks/2806-4c23bc690f47be07.js" defer=""></script><script src="/_next/static/chunks/542-ef49054f083e6f0b.js" defer=""></script><script src="/_next/static/chunks/7161-e7c65fd1cdc5407e.js" defer=""></script><script src="/_next/static/chunks/2053-ba2e26481a6c62bd.js" defer=""></script><script src="/_next/static/chunks/4011-5f58a1d57077b063.js" defer=""></script><script src="/_next/static/chunks/2918-48eb03835852e2f6.js" defer=""></script><script src="/_next/static/chunks/8161-6ea46acb38b819fc.js" defer=""></script><script src="/_next/static/chunks/pages/article/web/queue-in-js-9bf917156f8e8593.js" defer=""></script><script src="/_next/static/V1NM5DBh80CUpwnKxbtvX/_buildManifest.js" defer=""></script><script src="/_next/static/V1NM5DBh80CUpwnKxbtvX/_ssgManifest.js" defer=""></script></head><body><div id="__next"><header class="ant-layout-header nav_antdHeader__pc6AA"><div class="nav_header__K7RoR"><nav class="nav_headerLeft__D5kPR"><ul class="nav_navList__iDQNr"><li class="nav_navListItem__UblqT"><a href="/">文章</a></li><li class="nav_navListItem__UblqT"><a href="/favorites">收藏夹</a></li><li class="nav_navListItem__UblqT"><a href="/project">开源项目</a></li></ul></nav><div class="nav_headerRight__plZ1z"><div class="ant-space ant-space-horizontal ant-space-align-center"><div class="ant-space-item" style="margin-right:16px"><a class="nav_switchAddress__vhjXS" role="button" tabindex="0" aria-label="切换网站地址"><span role="img" aria-label="interaction" class="anticon anticon-interaction nav_switchAddressIcon__e5KfQ"><svg viewBox="64 64 896 896" focusable="false" data-icon="interaction" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M880 112H144c-17.7 0-32 14.3-32 32v736c0 17.7 14.3 32 32 32h736c17.7 0 32-14.3 32-32V144c0-17.7-14.3-32-32-32zm-40 728H184V184h656v656zM304.8 524h50.7c3.7 0 6.8-3 6.8-6.8v-78.9c0-19.7 15.9-35.6 35.5-35.6h205.7v53.4c0 5.7 6.5 8.8 10.9 5.3l109.1-85.7c3.5-2.7 3.5-8 0-10.7l-109.1-85.7c-4.4-3.5-10.9-.3-10.9 5.3V338H397.7c-55.1 0-99.7 44.8-99.7 100.1V517c0 4 3 7 6.8 7zm-4.2 134.9l109.1 85.7c4.4 3.5 10.9.3 10.9-5.3v-53.4h205.7c55.1 0 99.7-44.8 99.7-100.1v-78.9c0-3.7-3-6.8-6.8-6.8h-50.7c-3.7 0-6.8 3-6.8 6.8v78.9c0 19.7-15.9 35.6-35.5 35.6H420.6V568c0-5.7-6.5-8.8-10.9-5.3l-109.1 85.7c-3.5 2.5-3.5 7.8 0 10.5z"></path></svg></span></a></div><div class="ant-space-item"><a class="nav_githubLink__1sY1n" href="https://github.com/duan602728596" target="_blank" rel="noopener noreferrer"><picture class="block w-full h-full"><source srcSet="/images/github.avif" type="image/avif"/><source srcSet="/images/github.webp" type="image/webp"/><img class="block w-full h-full" src="/images/github.png" alt="github"/></picture></a></div></div></div></div></header><div class="main_main__ovwFV"><div class="mb-[16px] text-right"><button type="button" class="ant-btn ant-btn-default"><span role="img" aria-label="left" class="anticon anticon-left mr-[6px]"><svg viewBox="64 64 896 896" focusable="false" data-icon="left" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M724 218.3V141c0-6.7-7.7-10.4-12.9-6.3L260.3 486.8a31.86 31.86 0 000 50.3l450.8 352.1c5.3 4.1 12.9.4 12.9-6.3v-77.3c0-4.9-2.3-9.6-6.1-12.6l-360-281 360-281.1c3.8-3 6.1-7.7 6.1-12.6z"></path></svg></span><span>返回</span></button></div><h1 class="ant-typography">用JS实现多个任务并行执行的队列</h1><h2 class="ant-typography">使用场景</h2><div class="ant-typography">今天在开发时，碰到了这么一个需求：需要上传多个视频文件；每个文件的上传在新线程内执行；同时最多有三个上传任务在执行； 当一个任务执行完毕，执行下一个任务。这个需求就是并行执行队列内的任务。</div><div class="ant-typography">为了能够满足要求，需要知道可以同时执行的任务数、任务队列、正在执行的任务。当一个任务执行完毕后，需要分配下一个执行的任务。</div><h2 class="ant-typography">代码实现</h2><div class="ant-typography">首先定义一个类：</div><pre><div class="highLight_highLight__ZYqTW"><pre class="javascript"><code>class Queue {
  constructor(workerLen) {
    this.workerLen = workerLen ?? 3;         // 同时执行的任务数
    this.list = [];                          // 任务队列
    this.worker = new Array(this.workerLen); // 正在执行的任务
  }

  /**
   * 执行一个任务
   * @param { number } index
   * @param { Function } fn: 执行的函数
   * @param { Array } args: 传递给执行函数的参数
   */
  *executionFunc(index, fn, ...args) {
    const _this = this;

    yield fn.call(...args)
      .then(function() {
        // 任务执行完毕后，再次分配任务并执行任务
        _this.worker[index] = undefined;
        _this.run();
      });
  }

  /**
   * 添加到任务队列
   * @param { Array&lt;any[]&gt; } list: 任务队列
   */
  addList(list) {
    for (const item of list) {
      this.list.unshift(item);
    }
  }

  // 分配并执行任务
  run() {
    const runIndex = [];

    for (let i = 0; i &lt; this.workerLen; i++) {
      const len = this.list.length;

      if (!this.worker[i] &amp;&amp; len &gt; 0) {
        // 需要执行的任务
        this.worker[i] = this.executionFunc(i, ...this.list[len - 1]);

        runIndex.push(i);

        // 从任务队列内删除任务
        this.list.pop();
      }
    }

    // 执行任务
    for (const index of runIndex) {
      this.worker[index].next();
    }
  }
}
</code></pre></div></pre><div class="ant-typography">定义一个延迟执行的异步函数，并执行任务，测试代码是否满足需求：</div><pre><div class="highLight_highLight__ZYqTW"><pre class="javascript"><code>// 延迟执行的函数
function sleep(id, time) {
  console.log(&#x27;开始id&#x27;, id);

  return new Promise((resolve) =&gt; {
    setTimeout(() =&gt; {
      console.log(&#x27;结束id&#x27;, id);
      resolve();
    }, time * 1000);
  });
}

const queue = new Queue();

// 添加到任务队列
queue.addList([
  [sleep, undefined, &#x27;0001&#x27;, 3],
  [sleep, undefined, &#x27;0002&#x27;, 5],
  [sleep, undefined, &#x27;0003&#x27;, 8],
  [sleep, undefined, &#x27;0004&#x27;, 1],
  [sleep, undefined, &#x27;0005&#x27;, 12],
  [sleep, undefined, &#x27;0006&#x27;, 8],
  [sleep, undefined, &#x27;0007&#x27;, 2],
  [sleep, undefined, &#x27;0008&#x27;, 10]
]);

// 执行任务
queue.run();
</code></pre></div></pre><div class="ant-typography">在控制台上会输出：</div><pre><div class="highLight_highLight__ZYqTW"><pre><code>开始id 0001
开始id 0002
开始id 0003
结束id 0001
开始id 0004
结束id 0004
开始id 0005
结束id 0002
开始id 0006
结束id 0003
开始id 0007
结束id 0007
开始id 0008
结束id 0006
结束id 0005
结束id 0008
</code></pre></div></pre><div class="ant-typography">可以看到，开始时执行了三个任务；每当有任务执行完毕，就会执行下一个任务。这样就满足了并行执行队列内的任务的需求。</div><h2 class="ant-typography">代码演示</h2><div class="ant-typography">共有6个任务，每个任务过一定时间后完成。任务执行完成后执行下一个任务，最多有3个任务在执行。</div><div class="text-right mb-[16px]"><button type="button" class="ant-btn ant-btn-primary"><span>开始任务</span></button></div><div class="ant-table-wrapper"><div class="ant-spin-nested-loading"><div class="ant-spin-container"><div class="ant-table ant-table-middle ant-table-bordered"><div class="ant-table-container"><div class="ant-table-content"><table style="table-layout:auto"><colgroup><col style="width:33%"/><col style="width:33%"/><col style="width:33%"/></colgroup><thead class="ant-table-thead"><tr><th class="ant-table-cell">任务ID</th><th class="ant-table-cell">执行时间（s）</th><th class="ant-table-cell">执行状态</th></tr></thead><tbody class="ant-table-tbody"><tr data-row-key="1" class="ant-table-row ant-table-row-level-0"><td class="ant-table-cell">1</td><td class="ant-table-cell">3</td><td class="ant-table-cell"><span class="ant-tag">未执行</span></td></tr><tr data-row-key="2" class="ant-table-row ant-table-row-level-0"><td class="ant-table-cell">2</td><td class="ant-table-cell">9</td><td class="ant-table-cell"><span class="ant-tag">未执行</span></td></tr><tr data-row-key="3" class="ant-table-row ant-table-row-level-0"><td class="ant-table-cell">3</td><td class="ant-table-cell">12</td><td class="ant-table-cell"><span class="ant-tag">未执行</span></td></tr><tr data-row-key="4" class="ant-table-row ant-table-row-level-0"><td class="ant-table-cell">4</td><td class="ant-table-cell">5</td><td class="ant-table-cell"><span class="ant-tag">未执行</span></td></tr><tr data-row-key="5" class="ant-table-row ant-table-row-level-0"><td class="ant-table-cell">5</td><td class="ant-table-cell">7</td><td class="ant-table-cell"><span class="ant-tag">未执行</span></td></tr><tr data-row-key="6" class="ant-table-row ant-table-row-level-0"><td class="ant-table-cell">6</td><td class="ant-table-cell">1</td><td class="ant-table-cell"><span class="ant-tag">未执行</span></td></tr></tbody></table></div></div></div></div></div></div><p class="py-[16px] px-0"><b>已完成任务：</b><span class="ant-tag">无</span></p></div><span></span></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{}},"page":"/article/web/queue-in-js","query":{},"buildId":"V1NM5DBh80CUpwnKxbtvX","nextExport":true,"autoExport":true,"isFallback":false,"scriptLoader":[]}</script></body></html>