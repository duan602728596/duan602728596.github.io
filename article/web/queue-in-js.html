<!DOCTYPE html><html lang="zh-cmn-Hans"><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><title>用JS实现多个任务并行执行的队列</title><meta name="keywords" content="前端, js, javascript, typescript, node"/><meta name="description" content="用JS实现多个任务并行执行的队列"/><meta name="next-head-count" content="5"/><meta name="renderer" content="webkit"/><meta name="viewport" content="width=device-width, initial-scale=1"/><meta http-equiv="Window-target" content="_top"/><meta name="author" content="段昊辰, duanhaochen@126.com"/><meta name="copyright" content="段昊辰, duanhaochen@126.com"/><link rel="icon" href="/images/favicon.jpg" type="image/jpeg"/><link rel="stylesheet" href="/styles/28534371.ssr.css"/><link rel="stylesheet" href="/styles/github.css"/><link rel="preload" href="/_next/static/css/30aa850e76815cac.css" as="style" crossorigin=""/><link rel="stylesheet" href="/_next/static/css/30aa850e76815cac.css" crossorigin="" data-n-g=""/><link rel="preload" href="/_next/static/css/a4df808e46541d42.css" as="style" crossorigin=""/><link rel="stylesheet" href="/_next/static/css/a4df808e46541d42.css" crossorigin="" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" crossorigin="" nomodule="" src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script src="/_next/static/chunks/webpack-5e5e58242ce078c8.js" defer="" crossorigin=""></script><script src="/_next/static/chunks/framework-314c182fa7e2bf37.js" defer="" crossorigin=""></script><script src="/_next/static/chunks/main-fc6cb5345c9e5beb.js" defer="" crossorigin=""></script><script src="/_next/static/chunks/pages/_app-cc0e75cd9163d5a3.js" defer="" crossorigin=""></script><script src="/_next/static/chunks/932-9665145f9733b5ad.js" defer="" crossorigin=""></script><script src="/_next/static/chunks/416-bac69a7c3bc6e6fe.js" defer="" crossorigin=""></script><script src="/_next/static/chunks/3791-3f01c968a378d440.js" defer="" crossorigin=""></script><script src="/_next/static/chunks/9036-99bb285b1ee9ed4f.js" defer="" crossorigin=""></script><script src="/_next/static/chunks/8791-69933758e436d5e1.js" defer="" crossorigin=""></script><script src="/_next/static/chunks/5774-3231a99f861c70eb.js" defer="" crossorigin=""></script><script src="/_next/static/chunks/pages/article/web/queue-in-js-337cf219a3cd15fd.js" defer="" crossorigin=""></script><script src="/_next/static/CVgyDa2QQ5YyythVOVv4A/_buildManifest.js" defer="" crossorigin=""></script><script src="/_next/static/CVgyDa2QQ5YyythVOVv4A/_ssgManifest.js" defer="" crossorigin=""></script></head><body><div id="__next"><div class="nav_antdHeader__eCvl0"><div class="nav_header__y1mlw"><nav class="nav_headerLeft__PrT7_"><ul class="nav_navList__3HXot"><li class="nav_navListItem__hpAdz"><a href="/">文章</a></li><li class="nav_navListItem__hpAdz"><a href="/favorites">收藏夹</a></li><li class="nav_navListItem__hpAdz"><a href="/project">开源项目</a></li><li class="nav_navListItem__hpAdz"><a href="/friends">友情链接</a></li></ul></nav><div class="nav_headerRight__JfqYP"><div class="ant-space css-1xd99dr ant-space-horizontal ant-space-align-center" style="column-gap:16px;row-gap:16px"><div class="ant-space-item"><a class="nav_switchAddress__sVzqD" role="button" tabindex="0" aria-label="切换网站地址"><span role="img" aria-label="interaction" class="anticon anticon-interaction nav_switchAddressIcon__KLxGG"><svg viewBox="64 64 896 896" focusable="false" data-icon="interaction" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M880 112H144c-17.7 0-32 14.3-32 32v736c0 17.7 14.3 32 32 32h736c17.7 0 32-14.3 32-32V144c0-17.7-14.3-32-32-32zm-40 728H184V184h656v656zM304.8 524h50.7c3.7 0 6.8-3 6.8-6.8v-78.9c0-19.7 15.9-35.6 35.5-35.6h205.7v53.4c0 5.7 6.5 8.8 10.9 5.3l109.1-85.7c3.5-2.7 3.5-8 0-10.7l-109.1-85.7c-4.4-3.5-10.9-.3-10.9 5.3V338H397.7c-55.1 0-99.7 44.8-99.7 100.1V517c0 4 3 7 6.8 7zm-4.2 134.9l109.1 85.7c4.4 3.5 10.9.3 10.9-5.3v-53.4h205.7c55.1 0 99.7-44.8 99.7-100.1v-78.9c0-3.7-3-6.8-6.8-6.8h-50.7c-3.7 0-6.8 3-6.8 6.8v78.9c0 19.7-15.9 35.6-35.5 35.6H420.6V568c0-5.7-6.5-8.8-10.9-5.3l-109.1 85.7c-3.5 2.5-3.5 7.8 0 10.5z"></path></svg></span></a></div><div class="ant-space-item"><a class="nav_githubLink__BDzSl" href="https://github.com/duan602728596" target="_blank" rel="noopener noreferrer"><picture class="block w-full h-full"><source srcSet="/images/github.avif" type="image/avif"/><source srcSet="/images/github.webp" type="image/webp"/><img class="block w-full h-full" src="/images/github.png" alt="github"/></picture></a></div></div></div></div></div><div class="main_main__IZXSv"><div class="mb-[16px] text-right"><button type="button" class="ant-btn css-1xd99dr ant-btn-default"><span role="img" aria-label="left" class="anticon anticon-left mr-[6px]"><svg viewBox="64 64 896 896" focusable="false" data-icon="left" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M724 218.3V141c0-6.7-7.7-10.4-12.9-6.3L260.3 486.8a31.86 31.86 0 000 50.3l450.8 352.1c5.3 4.1 12.9.4 12.9-6.3v-77.3c0-4.9-2.3-9.6-6.1-12.6l-360-281 360-281.1c3.8-3 6.1-7.7 6.1-12.6z"></path></svg></span><span>返回</span></button></div><h1 class="ant-typography css-1xd99dr">用JS实现多个任务并行执行的队列</h1><h2 class="ant-typography css-1xd99dr">使用场景</h2><div class="ant-typography css-1xd99dr">今天在开发时，碰到了这么一个需求：需要上传多个视频文件；每个文件的上传在新线程内执行；同时最多有三个上传任务在执行； 当一个任务执行完毕，执行下一个任务。这个需求就是并行执行队列内的任务。</div><div class="ant-typography css-1xd99dr">为了能够满足要求，需要知道可以同时执行的任务数、任务队列、正在执行的任务。当一个任务执行完毕后，需要分配下一个执行的任务。</div><h2 class="ant-typography css-1xd99dr">代码实现</h2><div class="ant-typography css-1xd99dr">首先定义一个类：</div><pre><div class="highLight_highLight__7oxZf"><pre class="javascript"><code>class Queue {
  constructor(workerLen) {
    this.workerLen = workerLen ?? 3;         // 同时执行的任务数
    this.list = [];                          // 任务队列
    this.worker = new Array(this.workerLen); // 正在执行的任务
  }

  /**
   * 执行一个任务
   * @param { number } index
   * @param { Function } fn: 执行的函数
   * @param { Array } args: 传递给执行函数的参数
   */
  *executionFunc(index, fn, ...args) {
    const _this = this;

    yield fn.call(...args)
      .then(function() {
        // 任务执行完毕后，再次分配任务并执行任务
        _this.worker[index] = undefined;
        _this.run();
      });
  }

  /**
   * 添加到任务队列
   * @param { Array&lt;any[]&gt; } list: 任务队列
   */
  addList(list) {
    for (const item of list) {
      this.list.unshift(item);
    }
  }

  // 分配并执行任务
  run() {
    const runIndex = [];

    for (let i = 0; i &lt; this.workerLen; i++) {
      const len = this.list.length;

      if (!this.worker[i] &amp;&amp; len &gt; 0) {
        // 需要执行的任务
        this.worker[i] = this.executionFunc(i, ...this.list[len - 1]);

        runIndex.push(i);

        // 从任务队列内删除任务
        this.list.pop();
      }
    }

    // 执行任务
    for (const index of runIndex) {
      this.worker[index].next();
    }
  }
}
</code></pre></div></pre><div class="ant-typography css-1xd99dr">定义一个延迟执行的异步函数，并执行任务，测试代码是否满足需求：</div><pre><div class="highLight_highLight__7oxZf"><pre class="javascript"><code>// 延迟执行的函数
function sleep(id, time) {
  console.log(&#x27;开始id&#x27;, id);

  return new Promise((resolve) =&gt; {
    setTimeout(() =&gt; {
      console.log(&#x27;结束id&#x27;, id);
      resolve();
    }, time * 1000);
  });
}

const queue = new Queue();

// 添加到任务队列
queue.addList([
  [sleep, undefined, &#x27;0001&#x27;, 3],
  [sleep, undefined, &#x27;0002&#x27;, 5],
  [sleep, undefined, &#x27;0003&#x27;, 8],
  [sleep, undefined, &#x27;0004&#x27;, 1],
  [sleep, undefined, &#x27;0005&#x27;, 12],
  [sleep, undefined, &#x27;0006&#x27;, 8],
  [sleep, undefined, &#x27;0007&#x27;, 2],
  [sleep, undefined, &#x27;0008&#x27;, 10]
]);

// 执行任务
queue.run();
</code></pre></div></pre><div class="ant-typography css-1xd99dr">在控制台上会输出：</div><pre><div class="highLight_highLight__7oxZf"><pre><code>开始id 0001
开始id 0002
开始id 0003
结束id 0001
开始id 0004
结束id 0004
开始id 0005
结束id 0002
开始id 0006
结束id 0003
开始id 0007
结束id 0007
开始id 0008
结束id 0006
结束id 0005
结束id 0008
</code></pre></div></pre><div class="ant-typography css-1xd99dr">可以看到，开始时执行了三个任务；每当有任务执行完毕，就会执行下一个任务。这样就满足了并行执行队列内的任务的需求。</div><h2 class="ant-typography css-1xd99dr">代码演示</h2><div class="ant-typography css-1xd99dr">共有6个任务，每个任务过一定时间后完成。任务执行完成后执行下一个任务，最多有3个任务在执行。</div><div class="text-right mb-[16px]"><button type="button" class="ant-btn css-1xd99dr ant-btn-primary"><span>开始任务</span></button></div><div class="ant-table-wrapper css-1xd99dr"><div class="ant-spin-nested-loading css-1xd99dr"><div class="ant-spin-container"><div class="ant-table ant-table-middle ant-table-bordered css-1xd99dr"><div class="ant-table-container"><div class="ant-table-content"><table style="table-layout:auto"><colgroup><col style="width:33%"/><col style="width:33%"/><col style="width:33%"/></colgroup><thead class="ant-table-thead"><tr><th class="ant-table-cell" scope="col">任务ID</th><th class="ant-table-cell" scope="col">执行时间（s）</th><th class="ant-table-cell" scope="col">执行状态</th></tr></thead><tbody class="ant-table-tbody"><tr class="ant-table-row ant-table-row-level-0" data-row-key="1"><td class="ant-table-cell">1</td><td class="ant-table-cell">3</td><td class="ant-table-cell"><span class="ant-tag css-1xd99dr">未执行</span></td></tr><tr class="ant-table-row ant-table-row-level-0" data-row-key="2"><td class="ant-table-cell">2</td><td class="ant-table-cell">9</td><td class="ant-table-cell"><span class="ant-tag css-1xd99dr">未执行</span></td></tr><tr class="ant-table-row ant-table-row-level-0" data-row-key="3"><td class="ant-table-cell">3</td><td class="ant-table-cell">12</td><td class="ant-table-cell"><span class="ant-tag css-1xd99dr">未执行</span></td></tr><tr class="ant-table-row ant-table-row-level-0" data-row-key="4"><td class="ant-table-cell">4</td><td class="ant-table-cell">5</td><td class="ant-table-cell"><span class="ant-tag css-1xd99dr">未执行</span></td></tr><tr class="ant-table-row ant-table-row-level-0" data-row-key="5"><td class="ant-table-cell">5</td><td class="ant-table-cell">7</td><td class="ant-table-cell"><span class="ant-tag css-1xd99dr">未执行</span></td></tr><tr class="ant-table-row ant-table-row-level-0" data-row-key="6"><td class="ant-table-cell">6</td><td class="ant-table-cell">1</td><td class="ant-table-cell"><span class="ant-tag css-1xd99dr">未执行</span></td></tr></tbody></table></div></div></div></div></div></div><p class="py-[16px] px-0"><b>已完成任务：</b><span class="ant-tag css-1xd99dr">无</span></p></div><span></span></div><script id="__NEXT_DATA__" type="application/json" crossorigin="">{"props":{"pageProps":{}},"page":"/article/web/queue-in-js","query":{},"buildId":"CVgyDa2QQ5YyythVOVv4A","nextExport":true,"autoExport":true,"isFallback":false,"scriptLoader":[]}</script></body></html>