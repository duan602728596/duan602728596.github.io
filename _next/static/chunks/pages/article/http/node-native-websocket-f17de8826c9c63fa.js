(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[960],{76278:function(e,n,t){"use strict";t.d(n,{Z:function(){return s}});var a=t(87462),r=t(67294),o={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M512 64C264.6 64 64 264.6 64 512s200.6 448 448 448 448-200.6 448-448S759.4 64 512 64zm193.5 301.7l-210.6 292a31.8 31.8 0 01-51.7 0L318.5 484.9c-3.8-5.3 0-12.7 6.5-12.7h46.9c10.2 0 19.9 4.9 25.9 13.3l71.2 98.8 157.2-218c6-8.3 15.6-13.3 25.9-13.3H699c6.5 0 10.3 7.4 6.5 12.7z"}}]},name:"check-circle",theme:"filled"},c=t(93771),s=r.forwardRef(function(e,n){return r.createElement(c.Z,(0,a.Z)({},e,{ref:n,icon:o}))})},26702:function(e,n,t){"use strict";t.d(n,{Z:function(){return s}});var a=t(87462),r=t(67294),o={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M512 64C264.6 64 64 264.6 64 512s200.6 448 448 448 448-200.6 448-448S759.4 64 512 64zm-32 232c0-4.4 3.6-8 8-8h48c4.4 0 8 3.6 8 8v272c0 4.4-3.6 8-8 8h-48c-4.4 0-8-3.6-8-8V296zm32 440a48.01 48.01 0 010-96 48.01 48.01 0 010 96z"}}]},name:"exclamation-circle",theme:"filled"},c=t(93771),s=r.forwardRef(function(e,n){return r.createElement(c.Z,(0,a.Z)({},e,{ref:n,icon:o}))})},1558:function(e,n,t){"use strict";t.d(n,{Z:function(){return s}});var a=t(87462),r=t(67294),o={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M512 64C264.6 64 64 264.6 64 512s200.6 448 448 448 448-200.6 448-448S759.4 64 512 64zm32 664c0 4.4-3.6 8-8 8h-48c-4.4 0-8-3.6-8-8V456c0-4.4 3.6-8 8-8h48c4.4 0 8 3.6 8 8v272zm-32-344a48.01 48.01 0 010-96 48.01 48.01 0 010 96z"}}]},name:"info-circle",theme:"filled"},c=t(93771),s=r.forwardRef(function(e,n){return r.createElement(c.Z,(0,a.Z)({},e,{ref:n,icon:o}))})},42695:function(e,n,t){"use strict";t.r(n),t.d(n,{default:function(){return NodeNativeWebsocketPage}});var a=t(67294),r=t(9008),o=t.n(r),c=t(86471),s=t(67552),i=t.n(s),d=t(85893),l=t(11151),f=t(38925);function _createMdxContent(e){var n=i()({pre:"pre",code:"code"},(0,l.ah)(),e.components);return(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{className:"language-javascript",children:"import { createHash } from 'node:crypto';\n\n/* 对Sec-Websocket-Key进行加密，作为Sec-Websocket-Accept的值 */\nexport function encryptSocketKey(key) {\n  const WEBSOCKET_GUID = '258EAFA5-E914-47DA-95CA-C5AB0DC85B11';\n  const sha1Hash = createHash('sha1');\n\n  sha1Hash.update(`${ key }${ WEBSOCKET_GUID }`);\n\n  return sha1Hash.digest('base64');\n}\n\n/* 处理接收到的数据 */\nexport function decodeWsFrame(data) {\n  let start = 0;\n  const frame = {\n    isFinal: (data[start] & 0x80) === 0x80,\n    opcode: data[start++] & 0xF,\n    masked: (data[start] & 0x80) === 0x80,\n    payloadLen: data[start++] & 0x7F,\n    maskingKey: '',\n    payloadData: null\n  };\n\n  if (frame.payloadLen === 126) {\n    frame.payloadLen = (data[start++] << 8) + data[start++];\n  } else if (frame.payloadLen === 127) {\n    frame.payloadLen = 0;\n\n    for (let i = 7; i >= 0; i--) {\n      frame.payloadLen += (data[start++] << (i * 8));\n    }\n  }\n\n  if (frame.payloadLen) {\n    if (frame.masked) {\n      const maskingKey = [data[start++], data[start++], data[start++], data[start++]];\n\n      frame.maskingKey = maskingKey;\n      frame.payloadData = data\n        .subarray(start, start + frame.payloadLen)\n        .map((byte, index) => byte ^ maskingKey[index % 4]);\n    } else {\n      frame.payloadData = data.slice(start, start + frame.payloadLen);\n    }\n  }\n\n  return frame;\n}\n\n/* 处理发送的数据 */\nexport function encodeWsFrame(data) {\n  const isFinal = data.isFinal !== undefined ? data.isFinal : true,\n    opcode = data.opcode !== undefined ? data.opcode : 1,\n    payloadData = data.payloadData ? Buffer.from(data.payloadData) : null,\n    payloadLen = payloadData ? payloadData.length : 0;\n  const frame = [];\n\n  if (isFinal) {\n    frame.push((1 << 7) + opcode);\n  } else {\n    frame.push(opcode);\n  }\n\n  if (payloadLen < 126) {\n    frame.push(payloadLen);\n  } else if (payloadLen < 65536) {\n    frame.push(126, payloadLen >> 8, payloadLen & 0xFF);\n  } else {\n    frame.push(127);\n\n    for (let i = 7; i >= 0; i--) {\n      frame.push((payloadLen & (0xFF << (i * 8))) >> (i * 8));\n    }\n  }\n\n  return payloadData\n    ? Buffer.concat([Buffer.from(frame), payloadData])\n    : Buffer.from(frame);\n}\n\nexport function rStr(len: number): string {\n  const str: string = 'QWERTYUIOPASDFGHJKLZXCVBNM1234567890';\n  let result: string = '';\n\n  for (let i: number = 0; i < len; i++) {\n    const rIndex: number = Math.floor(Math.random() * str.length);\n\n    result += str[rIndex];\n  }\n\n  return result;\n}\n"})})}var utils=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=i()({},(0,l.ah)(),e.components).wrapper;return n?(0,d.jsx)(n,i()({},e,{children:(0,d.jsx)(_createMdxContent,e)})):_createMdxContent(e)};function webSocketServer_createMdxContent(e){var n=i()({pre:"pre",code:"code"},(0,l.ah)(),e.components);return(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{className:"language-javascript",children:"import net from 'node:net';\nimport { encodeWsFrame, decodeWsFrame, encryptSocketKey } from './utils.js';\n\n/* 建立请求 */\nfunction createConnect(socket) {\n  return new Promise((resolve, reject) => {\n    socket.once('data', function(buffer) {\n      const data = buffer.toString();\n      const headers = data.split('\\r\\n')\n        .splice(1)\n        .filter((o) => o !== '')\n        .reduce((result, header, index) => {\n          const [key, value] = header.split(': ');\n\n          result[key.toLowerCase()] = value;\n\n          return result;\n        }, {});\n\n      // 判断是否为websocket并检查版本\n      if (!(\n        headers.upgrade === 'websocket'\n        && headers['sec-websocket-version'] === '13'\n      )) {\n        socket.end();\n        resolve(false);\n\n        return;\n      }\n\n      const responseHeader = `HTTP/1.1 101 Switching Protocols\\r\nUpgrade: websocket\\r\nConnection: Upgrade\\r\nSec-Websocket-Accept: ${ encryptSocketKey(headers['sec-websocket-key']) }\\r\\n\\r\\n`\n\n      socket.write(responseHeader);\n      resolve(true);\n    });\n  });\n}\n\nconst server = net.createServer(async function(socket) {\n  const createResult = await createConnect(socket);\n\n  if (!createResult) return;\n\n  socket.on('data', function(buffer) {\n    const data = decodeWsFrame(buffer);\n    const { opcode, payloadData } = data;\n\n    if (opcode === 8) {\n      socket.end();\n    } else {\n      socket.write(encodeWsFrame({\n        opcode: 1,\n        payloadData: `接收：${ payloadData.toString() }`\n      }));\n    }\n  });\n});\n\nserver.listen(5059);\n"})})}var webSocketServer=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=i()({},(0,l.ah)(),e.components).wrapper;return n?(0,d.jsx)(n,i()({},e,{children:(0,d.jsx)(webSocketServer_createMdxContent,e)})):webSocketServer_createMdxContent(e)};function webSocketClient_createMdxContent(e){var n=i()({pre:"pre",code:"code"},(0,l.ah)(),e.components);return(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{className:"language-javascript",children:"import net from 'node:net';\nimport { setInterval } from 'node:timers';\nimport { encryptSocketKey, encodeWsFrame, decodeWsFrame, rStr } from './utils.js';\n\nconst client = new net.Socket();\n\n/* 建立请求 */\nfunction createConnect(client, uuid) {\n  return new Promise((resolve, reject) => {\n    client.once('data', function(buffer) {\n      const data = buffer.toString();\n      const headers = data.split('\\r\\n')\n        .splice(1)\n        .filter((o) => o !== '')\n        .reduce((result, header, index) => {\n          const [key, value] = header.split(': ');\n\n          result[key.toLowerCase()] = value;\n\n          return result;\n        }, {});\n\n      // 判断是否为websocket并检查版本\n      if (!(\n        headers.upgrade === 'websocket'\n        && headers['sec-websocket-accept'] === encryptSocketKey(uuid)\n      )) {\n        client.end();\n        resolve(false);\n\n        return;\n      }\n\n      resolve(true);\n    });\n  });\n}\n\nclient.connect(5059, '127.0.0.1', async function() {\n  const uuid = btoa(rStr(16));\n\n  client.write(`GET /index.html HTTP/1.1\\r\nConnection: Upgrade\\r\nUpgrade: websocket\\r\nSec-WebSocket-Key: ${ uuid }\\r\nSec-WebSocket-Version: 13\\r\\n\\r\\n`);\n\n  const createResult = await createConnect(client, uuid);\n\n  if (!createResult) return;\n\n  let i = 0;\n\n  client.on('data', function(buffer) {\n    const data = decodeWsFrame(buffer);\n\n    console.log(data.payloadData.toString());\n  });\n\n  setInterval(() => {\n    console.log(`发送：${ i }`);\n    client.write(encodeWsFrame({\n      opcode: 1,\n      payloadData: `${ i++ }`\n    }));\n  }, 3_000);\n});\n"})})}var webSocketClient=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=i()({},(0,l.ah)(),e.components).wrapper;return n?(0,d.jsx)(n,i()({},e,{children:(0,d.jsx)(webSocketClient_createMdxContent,e)})):webSocketClient_createMdxContent(e)};function nodeNativeWebsocket_createMdxContent(e){var n=i()({h1:"h1",p:"p",h2:"h2",div:"div",a:"a"},(0,l.ah)(),e.components);return(0,d.jsxs)(d.Fragment,{children:[(0,d.jsx)(n.h1,{children:"Nodejs原生实现WebSocket服务"}),"\n",(0,d.jsx)(n.p,{children:"这段Demo展示了如何使用Nodejs原生实现WebSocket服务。"}),"\n",(0,d.jsx)(n.p,{children:"加密和data处理的算法。"}),"\n",(0,d.jsx)(utils,{}),"\n",(0,d.jsx)(n.p,{children:"服务端的实现。"}),"\n",(0,d.jsx)(webSocketServer,{}),"\n",(0,d.jsx)(n.p,{children:"客户端的实现。"}),"\n",(0,d.jsx)(webSocketClient,{}),"\n",(0,d.jsx)(f.Z,{type:"info",message:[(0,d.jsx)(n.h2,{className:"mb-0 py-[8px] text-[16px]",children:"参考地址："},"cankaodizhi"),(0,d.jsxs)(n.div,{className:"py-[8px]",children:["The WebSocket Protocol:",(0,d.jsx)(n.a,{href:"https://tools.ietf.org/html/rfc6455",target:"_blank",rel:"noopener noreferrer",children:"https://tools.ietf.org/html/rfc6455"})]},"rfc6455"),(0,d.jsxs)(n.div,{className:"py-[8px]",children:["nodejs net sockets + websocket without socket.io:",(0,d.jsx)(n.a,{href:"https://stackoverflow.com/questions/32808988/nodejs-net-sockets-websocket-without-socket-io",target:"_blank",rel:"noopener noreferrer",children:"https://stackoverflow.com/questions/32808988/nodejs-net-sockets-websocket-without-socket-io"})]},"rfc6455"),(0,d.jsxs)(n.div,{className:"py-[8px]",children:['What does "258EAFA5-E914-47DA-95CA-C5AB0DC85B11" means in WebSocket Protocol:',(0,d.jsx)(n.a,{href:"https://stackoverflow.com/questions/13456017/what-does-258eafa5-e914-47da-95ca-c5ab0dc85b11-means-in-websocket-protocol",target:"_blank",rel:"noopener noreferrer",children:"https://stackoverflow.com/questions/13456017/what-does-258eafa5-e914-47da-95ca-c5ab0dc85b11-means-in-websocket-protocol"})]},"stackoverflow")]})]})}var nodeNativeWebsocket=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=i()({},(0,l.ah)(),e.components).wrapper;return n?(0,d.jsx)(n,i()({},e,{children:(0,d.jsx)(nodeNativeWebsocket_createMdxContent,e)})):nodeNativeWebsocket_createMdxContent(e)},NodeNativeWebSocket_NodeNativeWebsocket=function(e){return(0,d.jsx)(c.Z,{children:(0,d.jsx)(nodeNativeWebsocket,{})})};function NodeNativeWebsocketPage(e){return(0,d.jsxs)(a.Fragment,{children:[(0,d.jsxs)(o(),{children:[(0,d.jsx)("title",{children:"Nodejs原生实现WebSocket服务"}),(0,d.jsx)("meta",{name:"keywords",content:"websocket,nodejs"}),(0,d.jsx)("meta",{name:"description",content:"Nodejs原生实现WebSocket服务"})]}),(0,d.jsx)(NodeNativeWebSocket_NodeNativeWebsocket,{})]})}},93624:function(e,n,t){(window.__NEXT_P=window.__NEXT_P||[]).push(["/article/http/node-native-websocket",function(){return t(42695)}])}},function(e){e.O(0,[4322,1447,9166,2072,9774,2888,179],function(){return e(e.s=93624)}),_N_E=e.O()}]);