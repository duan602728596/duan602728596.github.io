(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[960],{85139:function(e,n,t){"use strict";t.r(n),t.d(n,{default:function(){return $}});var a=t(67294),r=t(9008),o=t.n(r),s=t(55147),c=t(62079),i=t.n(c),l=t(52020),d=t.n(l),u=t(73324),f=t.n(u),p=t(88546),h=t.n(p),m=t(99595),x=t.n(m),v=t(66775),b=t.n(v),j=t(2201),k=t.n(j),y=t(57445),g=t.n(y),w=t(44845),_=t(85893),S=t(11151),N=t(38925);function L(e,n){var t=i()(e);if(d()){var a=d()(e);n&&(a=f()(a).call(a,function(n){return h()(e,n).enumerable})),t.push.apply(t,a)}return t}function F(e){for(var n=1;n<arguments.length;n++){var t,a,r=null!=arguments[n]?arguments[n]:{};n%2?x()(t=L(Object(r),!0)).call(t,function(n){(0,w.Z)(e,n,r[n])}):b()?k()(e,b()(r)):x()(a=L(Object(r))).call(a,function(n){g()(e,n,h()(r,n))})}return e}function D(e){var n=F(F({code:"code",pre:"pre"},(0,S.a)()),e.components);return(0,_.jsx)(n.pre,{children:(0,_.jsx)(n.code,{className:"language-javascript",children:"import { createHash } from 'node:crypto';\n\n/* 对Sec-Websocket-Key进行加密，作为Sec-Websocket-Accept的值 */\nexport function encryptSocketKey(key) {\n  const WEBSOCKET_GUID = '258EAFA5-E914-47DA-95CA-C5AB0DC85B11';\n  const sha1Hash = createHash('sha1');\n\n  sha1Hash.update(`${ key }${ WEBSOCKET_GUID }`);\n\n  return sha1Hash.digest('base64');\n}\n\n/* 处理接收到的数据 */\nexport function decodeWsFrame(data) {\n  let start = 0;\n  const frame = {\n    isFinal: (data[start] & 0x80) === 0x80,\n    opcode: data[start++] & 0xF,\n    masked: (data[start] & 0x80) === 0x80,\n    payloadLen: data[start++] & 0x7F,\n    maskingKey: '',\n    payloadData: null\n  };\n\n  if (frame.payloadLen === 126) {\n    frame.payloadLen = (data[start++] << 8) + data[start++];\n  } else if (frame.payloadLen === 127) {\n    frame.payloadLen = 0;\n\n    for (let i = 7; i >= 0; i--) {\n      frame.payloadLen += (data[start++] << (i * 8));\n    }\n  }\n\n  if (frame.payloadLen) {\n    if (frame.masked) {\n      const maskingKey = [data[start++], data[start++], data[start++], data[start++]];\n\n      frame.maskingKey = maskingKey;\n      frame.payloadData = data\n        .subarray(start, start + frame.payloadLen)\n        .map((byte, index) => byte ^ maskingKey[index % 4]);\n    } else {\n      frame.payloadData = data.slice(start, start + frame.payloadLen);\n    }\n  }\n\n  return frame;\n}\n\n/* 处理发送的数据 */\nexport function encodeWsFrame(data) {\n  const isFinal = data.isFinal !== undefined ? data.isFinal : true,\n    opcode = data.opcode !== undefined ? data.opcode : 1,\n    payloadData = data.payloadData ? Buffer.from(data.payloadData) : null,\n    payloadLen = payloadData ? payloadData.length : 0;\n  const frame = [];\n\n  if (isFinal) {\n    frame.push((1 << 7) + opcode);\n  } else {\n    frame.push(opcode);\n  }\n\n  if (payloadLen < 126) {\n    frame.push(payloadLen);\n  } else if (payloadLen < 65536) {\n    frame.push(126, payloadLen >> 8, payloadLen & 0xFF);\n  } else {\n    frame.push(127);\n\n    for (let i = 7; i >= 0; i--) {\n      frame.push((payloadLen & (0xFF << (i * 8))) >> (i * 8));\n    }\n  }\n\n  return payloadData\n    ? Buffer.concat([Buffer.from(frame), payloadData])\n    : Buffer.from(frame);\n}\n\nexport function rStr(len: number): string {\n  const str: string = 'QWERTYUIOPASDFGHJKLZXCVBNM1234567890';\n  let result: string = '';\n\n  for (let i: number = 0; i < len; i++) {\n    const rIndex: number = Math.floor(Math.random() * str.length);\n\n    result += str[rIndex];\n  }\n\n  return result;\n}\n"})})}function W(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=F(F({},(0,S.a)()),e.components).wrapper;return n?(0,_.jsx)(n,F(F({},e),{},{children:(0,_.jsx)(D,F({},e))})):D(e)}function C(e,n){var t=i()(e);if(d()){var a=d()(e);n&&(a=f()(a).call(a,function(n){return h()(e,n).enumerable})),t.push.apply(t,a)}return t}function Z(e){for(var n=1;n<arguments.length;n++){var t,a,r=null!=arguments[n]?arguments[n]:{};n%2?x()(t=C(Object(r),!0)).call(t,function(n){(0,w.Z)(e,n,r[n])}):b()?k()(e,b()(r)):x()(a=C(Object(r))).call(a,function(n){g()(e,n,h()(r,n))})}return e}function T(e){var n=Z(Z({code:"code",pre:"pre"},(0,S.a)()),e.components);return(0,_.jsx)(n.pre,{children:(0,_.jsx)(n.code,{className:"language-javascript",children:"import net from 'node:net';\nimport { encodeWsFrame, decodeWsFrame, encryptSocketKey } from './utils.js';\n\n/* 建立请求 */\nfunction createConnect(socket) {\n  return new Promise((resolve, reject) => {\n    socket.once('data', function(buffer) {\n      const data = buffer.toString();\n      const headers = data.split('\\r\\n')\n        .splice(1)\n        .filter((o) => o !== '')\n        .reduce((result, header, index) => {\n          const [key, value] = header.split(': ');\n\n          result[key.toLowerCase()] = value;\n\n          return result;\n        }, {});\n\n      // 判断是否为websocket并检查版本\n      if (!(\n        headers.upgrade === 'websocket'\n        && headers['sec-websocket-version'] === '13'\n      )) {\n        socket.end();\n        resolve(false);\n\n        return;\n      }\n\n      const responseHeader = `HTTP/1.1 101 Switching Protocols\\r\nUpgrade: websocket\\r\nConnection: Upgrade\\r\nSec-Websocket-Accept: ${ encryptSocketKey(headers['sec-websocket-key']) }\\r\\n\\r\\n`\n\n      socket.write(responseHeader);\n      resolve(true);\n    });\n  });\n}\n\nconst server = net.createServer(async function(socket) {\n  const createResult = await createConnect(socket);\n\n  if (!createResult) return;\n\n  socket.on('data', function(buffer) {\n    const data = decodeWsFrame(buffer);\n    const { opcode, payloadData } = data;\n\n    if (opcode === 8) {\n      socket.end();\n    } else {\n      socket.write(encodeWsFrame({\n        opcode: 1,\n        payloadData: `接收：${ payloadData.toString() }`\n      }));\n    }\n  });\n});\n\nserver.listen(5059);\n"})})}function A(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=Z(Z({},(0,S.a)()),e.components).wrapper;return n?(0,_.jsx)(n,Z(Z({},e),{},{children:(0,_.jsx)(T,Z({},e))})):T(e)}function I(e,n){var t=i()(e);if(d()){var a=d()(e);n&&(a=f()(a).call(a,function(n){return h()(e,n).enumerable})),t.push.apply(t,a)}return t}function K(e){for(var n=1;n<arguments.length;n++){var t,a,r=null!=arguments[n]?arguments[n]:{};n%2?x()(t=I(Object(r),!0)).call(t,function(n){(0,w.Z)(e,n,r[n])}):b()?k()(e,b()(r)):x()(a=I(Object(r))).call(a,function(n){g()(e,n,h()(r,n))})}return e}function B(e){var n=K(K({code:"code",pre:"pre"},(0,S.a)()),e.components);return(0,_.jsx)(n.pre,{children:(0,_.jsx)(n.code,{className:"language-javascript",children:"import net from 'node:net';\nimport { setInterval } from 'node:timers';\nimport { encryptSocketKey, encodeWsFrame, decodeWsFrame, rStr } from './utils.js';\n\nconst client = new net.Socket();\n\n/* 建立请求 */\nfunction createConnect(client, uuid) {\n  return new Promise((resolve, reject) => {\n    client.once('data', function(buffer) {\n      const data = buffer.toString();\n      const headers = data.split('\\r\\n')\n        .splice(1)\n        .filter((o) => o !== '')\n        .reduce((result, header, index) => {\n          const [key, value] = header.split(': ');\n\n          result[key.toLowerCase()] = value;\n\n          return result;\n        }, {});\n\n      // 判断是否为websocket并检查版本\n      if (!(\n        headers.upgrade === 'websocket'\n        && headers['sec-websocket-accept'] === encryptSocketKey(uuid)\n      )) {\n        client.end();\n        resolve(false);\n\n        return;\n      }\n\n      resolve(true);\n    });\n  });\n}\n\nclient.connect(5059, '127.0.0.1', async function() {\n  const uuid = btoa(rStr(16));\n\n  client.write(`GET /index.html HTTP/1.1\\r\nConnection: Upgrade\\r\nUpgrade: websocket\\r\nSec-WebSocket-Key: ${ uuid }\\r\nSec-WebSocket-Version: 13\\r\\n\\r\\n`);\n\n  const createResult = await createConnect(client, uuid);\n\n  if (!createResult) return;\n\n  let i = 0;\n\n  client.on('data', function(buffer) {\n    const data = decodeWsFrame(buffer);\n\n    console.log(data.payloadData.toString());\n  });\n\n  setInterval(() => {\n    console.log(`发送：${ i }`);\n    client.write(encodeWsFrame({\n      opcode: 1,\n      payloadData: `${ i++ }`\n    }));\n  }, 3_000);\n});\n"})})}function E(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=K(K({},(0,S.a)()),e.components).wrapper;return n?(0,_.jsx)(n,K(K({},e),{},{children:(0,_.jsx)(B,K({},e))})):B(e)}function H(e,n){var t=i()(e);if(d()){var a=d()(e);n&&(a=f()(a).call(a,function(n){return h()(e,n).enumerable})),t.push.apply(t,a)}return t}function P(e){for(var n=1;n<arguments.length;n++){var t,a,r=null!=arguments[n]?arguments[n]:{};n%2?x()(t=H(Object(r),!0)).call(t,function(n){(0,w.Z)(e,n,r[n])}):b()?k()(e,b()(r)):x()(a=H(Object(r))).call(a,function(n){g()(e,n,h()(r,n))})}return e}function O(e){var n=P(P({a:"a",div:"div",h1:"h1",h2:"h2",p:"p"},(0,S.a)()),e.components);return(0,_.jsxs)(_.Fragment,{children:[(0,_.jsx)(n.h1,{children:"Nodejs原生实现WebSocket服务"}),"\n",(0,_.jsx)(n.p,{children:"这段Demo展示了如何使用Nodejs原生实现WebSocket服务。"}),"\n",(0,_.jsx)(n.p,{children:"加密和data处理的算法。"}),"\n",(0,_.jsx)(W,{}),"\n",(0,_.jsx)(n.p,{children:"服务端的实现。"}),"\n",(0,_.jsx)(A,{}),"\n",(0,_.jsx)(n.p,{children:"客户端的实现。"}),"\n",(0,_.jsx)(E,{}),"\n",(0,_.jsx)(N.Z,{type:"info",message:[(0,_.jsx)(n.h2,{className:"mb-0 py-[8px] text-[16px]",children:"参考地址："},"cankaodizhi"),(0,_.jsxs)(n.div,{className:"py-[8px]",children:["The WebSocket Protocol:",(0,_.jsx)(n.a,{href:"https://tools.ietf.org/html/rfc6455",target:"_blank",rel:"noopener noreferrer",children:"https://tools.ietf.org/html/rfc6455"})]},"rfc6455"),(0,_.jsxs)(n.div,{className:"py-[8px]",children:["nodejs net sockets + websocket without socket.io:",(0,_.jsx)(n.a,{href:"https://stackoverflow.com/questions/32808988/nodejs-net-sockets-websocket-without-socket-io",target:"_blank",rel:"noopener noreferrer",children:"https://stackoverflow.com/questions/32808988/nodejs-net-sockets-websocket-without-socket-io"})]},"rfc6455"),(0,_.jsxs)(n.div,{className:"py-[8px]",children:['What does "258EAFA5-E914-47DA-95CA-C5AB0DC85B11" means in WebSocket Protocol:',(0,_.jsx)(n.a,{href:"https://stackoverflow.com/questions/13456017/what-does-258eafa5-e914-47da-95ca-c5ab0dc85b11-means-in-websocket-protocol",target:"_blank",rel:"noopener noreferrer",children:"https://stackoverflow.com/questions/13456017/what-does-258eafa5-e914-47da-95ca-c5ab0dc85b11-means-in-websocket-protocol"})]},"stackoverflow")]})]})}function R(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=P(P({},(0,S.a)()),e.components).wrapper;return n?(0,_.jsx)(n,P(P({},e),{},{children:(0,_.jsx)(O,P({},e))})):O(e)}var U=function(e){return(0,_.jsx)(s.Z,{children:(0,_.jsx)(R,{})})};function $(e){return(0,_.jsxs)(a.Fragment,{children:[(0,_.jsxs)(o(),{children:[(0,_.jsx)("title",{children:"Nodejs原生实现WebSocket服务"}),(0,_.jsx)("meta",{name:"keywords",content:"websocket,nodejs"}),(0,_.jsx)("meta",{name:"description",content:"Nodejs原生实现WebSocket服务"})]}),(0,_.jsx)(U,{})]})}},39243:function(e,n,t){"use strict";var a=t(19623),r=t(73935),o=t(11163),s=t(81860),c=t(18610),i=t(75162),l=t(6171),d=t(76467),u=t(63791),f=t.n(u),p=t(85893),h=s.Z.BackTop;n.Z=function(e){var n=(0,o.useRouter)();return[(0,p.jsxs)("div",{className:f().main,children:[e.goBack?(0,p.jsx)("div",{className:"mb-[16px] text-right",children:(0,p.jsxs)(c.ZP,{onClick:function(e){n.push("/")},children:[(0,p.jsx)(l.Z,{className:"mr-[6px]"}),"返回"]})}):null,null==e?void 0:e.children]},"main"),(0,p.jsx)(d.default,{children:null!=e&&e.goToTop&&("undefined"==typeof document?"undefined":(0,a.Z)(document))==="object"?(0,r.createPortal)((0,p.jsx)(h,{type:"primary",icon:(0,p.jsx)(i.Z,{}),title:"返回顶部",tabIndex:0,role:"button","aria-label":"返回顶部"}),document.body):null},"backTop")]}},31725:function(e,n,t){"use strict";t(64043);var a=t(88946),r=t.n(a),o=t(81290),s=t.n(o),c=t(41664),i=t.n(c),l=t(21612),d=t(78957),u=t(83062),f=t(67337),p=t(32958),h=t.n(p),m=t(96808),x=t(85893),v=[{href:"/",title:"文章"},{href:"/favorites",title:"收藏夹"},{href:"/project",title:"开源项目"}],b=["github.io","vercel.app"],j=r()(v).call(v,function(e,n){return(0,x.jsx)("li",{className:h().navListItem,children:(0,x.jsx)(i(),{href:e.href,children:e.title})},e.href)});n.Z=function(e){return(0,x.jsx)(l.Z.Header,{className:h().antdHeader,children:(0,x.jsxs)("div",{className:h().header,children:[(0,x.jsx)("nav",{className:h().headerLeft,children:(0,x.jsx)("ul",{className:h().navList,children:j})}),(0,x.jsx)("div",{className:h().headerRight,children:(0,x.jsxs)(d.Z,{size:16,children:[(0,x.jsx)(u.Z,{title:"切换网站地址",children:(0,x.jsx)("a",{className:h().switchAddress,role:"button",tabIndex:0,"aria-label":"切换网站地址",onClick:function(e){var n=window.location,t=n.pathname,a=n.hostname,r=/github\.io/.test(a);window.location.href=new(s())(t,"https://duan602728596.".concat(b[r?1:0],"/"))},children:(0,x.jsx)(f.Z,{className:h().switchAddressIcon})})}),(0,x.jsx)("a",{className:h().githubLink,href:"https://github.com/duan602728596",target:"_blank",rel:"noopener noreferrer",children:(0,x.jsx)(m.Z,{className:"block w-full h-full",imageClassName:"block w-full h-full",avifSrc:"/images/github.avif",webpSrc:"/images/github.webp",src:"/images/github.png",alt:"github"})})]})})]})})}},96808:function(e,n,t){"use strict";var a=t(85893);n.Z=function(e){var n=e.className,t=e.imageClassName,r=e.avifSrc,o=e.webpSrc,s=e.src,c=e.alt;return(0,a.jsxs)("picture",{className:n,children:[r&&(0,a.jsx)("source",{srcSet:r,type:"image/avif"}),o&&(0,a.jsx)("source",{srcSet:o,type:"image/webp"}),(0,a.jsx)("img",{className:t,src:s,alt:c})]})}},55147:function(e,n,t){"use strict";var a=t(67294),r=t(31725),o=t(39243),s=t(85893);n.Z=function(e){return(0,s.jsxs)(a.Fragment,{children:[(0,s.jsx)(r.Z,{}),(0,s.jsx)(o.Z,{goToTop:!0,goBack:!0,children:e.children})]})}},93624:function(e,n,t){(window.__NEXT_P=window.__NEXT_P||[]).push(["/article/http/node-native-websocket",function(){return t(85139)}])},63791:function(e){e.exports={main:"main_main__IZXSv",goToTop:"main_goToTop__Py8c8"}},32958:function(e){e.exports={antdHeader:"nav_antdHeader__eCvl0",header:"nav_header__y1mlw",headerLeft:"nav_headerLeft__PrT7_",headerRight:"nav_headerRight__JfqYP",navList:"nav_navList__3HXot",navListItem:"nav_navListItem__hpAdz",switchAddress:"nav_switchAddress__sVzqD",githubLink:"nav_githubLink__BDzSl",switchAddressIcon:"nav_switchAddressIcon__KLxGG"}}},function(e){e.O(0,[8610,1447,4530,8925,9774,2888,179],function(){return e(e.s=93624)}),_N_E=e.O()}]);