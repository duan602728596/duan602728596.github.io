(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[3073],{47727:function(e,n,t){(window.__NEXT_P=window.__NEXT_P||[]).push(["/article/web/queue-in-js",function(){return t(16306)}])},16306:function(e,n,t){"use strict";t.r(n),t.d(n,{default:function(){return L}});var i=t(85893),s=t(67294),r=t(9008),a=t.n(r),l=t(76315),d=t(30673),c=t(79977),o=t(10932),u=t(1561);class h{*executionFunc(e,n){for(var t=arguments.length,i=Array(t>2?t-2:0),s=2;s<t;s++)i[s-2]=arguments[s];let r=this;yield n.call(...i).then(function(){r.worker[e]=void 0,r.run()})}addList(e){for(let n of e)this.list.unshift(n)}run(){let e=[];for(let n=0;n<this.workerLen;n++){let t=this.list.length;!this.worker[n]&&t>0&&(this.worker[n]=this.executionFunc(n,...this.list[t-1]),e.push(n),this.list.pop())}for(let n of e)this.worker[n].next()}constructor(e){this.workerLen=null!=e?e:3,this.list=[],this.worker=Array(this.workerLen)}}let{Title:p,Paragraph:x}=l.default,f=new h;var m=function(e){let[n,t]=(0,s.useState)([{id:"1",endTime:3,status:0},{id:"2",endTime:9,status:0},{id:"3",endTime:12,status:0},{id:"4",endTime:5,status:0},{id:"5",endTime:7,status:0},{id:"6",endTime:1,status:0}]),[r,a]=(0,s.useState)([]),[l,d]=(0,s.useState)(void 0),[h,m]=(0,s.useState)(!1);function j(e){return e.status=1,t(e=>[...e]),new Promise((n,i)=>{setTimeout(()=>{e.status=2,t(e=>[...e]);let i=[];a(n=>i=[...n,e.id]),6===i.length&&d(void 0),n()},1e3*e.endTime)})}return(0,i.jsxs)(s.Fragment,{children:[(0,i.jsx)(p,{level:2,children:"代码演示"}),(0,i.jsx)(x,{children:"共有6个任务，每个任务过一定时间后完成。任务执行完成后执行下一个任务，最多有3个任务在执行。"}),(0,i.jsx)("div",{className:"text-right mb-[16px]",children:h?(0,i.jsx)(o.ZP,{type:"primary",danger:!0,disabled:l,onClick:function(e){t(n.map(e=>(e.status=0,e))),m(!1),a([])},children:"重置任务"}):(0,i.jsx)(o.ZP,{type:"primary",onClick:function(e){d(!0),m(!0);let t=n.map((e,n)=>[j,void 0,e]);f.addList(t),f.run()},children:"开始任务"})}),(0,i.jsx)(u.Z,{size:"middle",bordered:!0,columns:[{title:"任务ID",dataIndex:"id",width:"33%"},{title:"执行时间（s）",dataIndex:"endTime",width:"33%"},{title:"执行状态",dataIndex:"status",width:"33%",render(e,n,t){switch(e){case 0:return(0,i.jsx)(c.Z,{children:"未执行"});case 1:return(0,i.jsx)(c.Z,{color:"#f50",children:"执行中"});case 2:return(0,i.jsx)(c.Z,{color:"#87d068",children:"执行完毕"})}}}],dataSource:n,rowKey:"id",pagination:!1}),(0,i.jsxs)("p",{className:"py-[16px] px-0",children:[(0,i.jsx)("b",{children:"已完成任务："}),0===r.length?(0,i.jsx)(c.Z,{children:"无"}):r.map((e,n)=>(0,i.jsxs)(c.Z,{color:n%2==0?"magenta":"purple",children:["任务",e]},e))]})]})},j=t(11151);function g(e){let n={code:"code",pre:"pre",...(0,j.a)(),...e.components};return(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-javascript",children:"class Queue {\n  constructor(workerLen) {\n    this.workerLen = workerLen ?? 3;         // 同时执行的任务数\n    this.list = [];                          // 任务队列\n    this.worker = new Array(this.workerLen); // 正在执行的任务\n  }\n\n  /**\n   * 执行一个任务\n   * @param { number } index\n   * @param { Function } fn: 执行的函数\n   * @param { Array } args: 传递给执行函数的参数\n   */\n  *executionFunc(index, fn, ...args) {\n    const _this = this;\n\n    yield fn.call(...args)\n      .then(function() {\n        // 任务执行完毕后，再次分配任务并执行任务\n        _this.worker[index] = undefined;\n        _this.run();\n      });\n  }\n\n  /**\n   * 添加到任务队列\n   * @param { Array<any[]> } list: 任务队列\n   */\n  addList(list) {\n    for (const item of list) {\n      this.list.unshift(item);\n    }\n  }\n\n  // 分配并执行任务\n  run() {\n    const runIndex = [];\n\n    for (let i = 0; i < this.workerLen; i++) {\n      const len = this.list.length;\n\n      if (!this.worker[i] && len > 0) {\n        // 需要执行的任务\n        this.worker[i] = this.executionFunc(i, ...this.list[len - 1]);\n\n        runIndex.push(i);\n\n        // 从任务队列内删除任务\n        this.list.pop();\n      }\n    }\n\n    // 执行任务\n    for (const index of runIndex) {\n      this.worker[index].next();\n    }\n  }\n}\n"})})}function w(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{wrapper:n}={...(0,j.a)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(g,{...e})}):g(e)}function v(e){let n={code:"code",pre:"pre",...(0,j.a)(),...e.components};return(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-javascript",children:"// 延迟执行的函数\nfunction sleep(id, time) {\n  console.log('开始id', id);\n\n  return new Promise((resolve) => {\n    setTimeout(() => {\n      console.log('结束id', id);\n      resolve();\n    }, time * 1000);\n  });\n}\n\nconst queue = new Queue();\n\n// 添加到任务队列\nqueue.addList([\n  [sleep, undefined, '0001', 3],\n  [sleep, undefined, '0002', 5],\n  [sleep, undefined, '0003', 8],\n  [sleep, undefined, '0004', 1],\n  [sleep, undefined, '0005', 12],\n  [sleep, undefined, '0006', 8],\n  [sleep, undefined, '0007', 2],\n  [sleep, undefined, '0008', 10]\n]);\n\n// 执行任务\nqueue.run();\n"})})}function _(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{wrapper:n}={...(0,j.a)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(v,{...e})}):v(e)}function b(e){let n={code:"code",pre:"pre",...(0,j.a)(),...e.components};return(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"开始id 0001\n开始id 0002\n开始id 0003\n结束id 0001\n开始id 0004\n结束id 0004\n开始id 0005\n结束id 0002\n开始id 0006\n结束id 0003\n开始id 0007\n结束id 0007\n开始id 0008\n结束id 0006\n结束id 0005\n结束id 0008\n"})})}function k(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{wrapper:n}={...(0,j.a)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(b,{...e})}):b(e)}let{Title:N,Paragraph:T}=l.default;var y=function(e){return(0,i.jsxs)(d.Z,{children:[(0,i.jsx)(N,{children:"用JS实现多个任务并行执行的队列"}),(0,i.jsx)(N,{level:2,children:"使用场景"}),(0,i.jsx)(T,{children:"今天在开发时，碰到了这么一个需求：需要上传多个视频文件；每个文件的上传在新线程内执行；同时最多有三个上传任务在执行； 当一个任务执行完毕，执行下一个任务。这个需求就是并行执行队列内的任务。"}),(0,i.jsx)(T,{children:"为了能够满足要求，需要知道可以同时执行的任务数、任务队列、正在执行的任务。当一个任务执行完毕后，需要分配下一个执行的任务。"}),(0,i.jsx)(N,{level:2,children:"代码实现"}),(0,i.jsx)(T,{children:"首先定义一个类："}),(0,i.jsx)(w,{}),(0,i.jsx)(T,{children:"定义一个延迟执行的异步函数，并执行任务，测试代码是否满足需求："}),(0,i.jsx)(_,{}),(0,i.jsx)(T,{children:"在控制台上会输出："}),(0,i.jsx)(k,{}),(0,i.jsx)(T,{children:"可以看到，开始时执行了三个任务；每当有任务执行完毕，就会执行下一个任务。这样就满足了并行执行队列内的任务的需求。"}),(0,i.jsx)(m,{})]})};function L(e){return(0,i.jsxs)(s.Fragment,{children:[(0,i.jsxs)(a(),{children:[(0,i.jsx)("title",{children:"用JS实现多个任务并行执行的队列"}),(0,i.jsx)("meta",{name:"keywords",content:"前端, js, javascript, typescript, node"}),(0,i.jsx)("meta",{name:"description",content:"用JS实现多个任务并行执行的队列"})]}),(0,i.jsx)(y,{})]})}},39182:function(e,n,t){"use strict";var i=t(85893),s=t(45697),r=t.n(s);function a(e){let{href:n,className:t,children:s}=e;return(0,i.jsx)("a",{className:t,href:n,target:"_blank",rel:"noopener noreferrer",children:s})}a.propTypes={href:r().string.isRequired,className:r().string,children:r().node.isRequired},n.Z=a},99388:function(e,n,t){"use strict";var i=t(85893),s=t(73935),r=t(45697),a=t.n(r),l=t(11163),d=t(81860),c=t(10932),o=t(75162),u=t(6171),h=t(76467),p=t(63791),x=t.n(p);let{BackTop:f}=d.default;function m(e){let n=(0,l.useRouter)();return[(0,i.jsxs)("div",{className:x().main,children:[e.goBack?(0,i.jsx)("div",{className:"mb-[16px] text-right",children:(0,i.jsxs)(c.ZP,{onClick:function(e){n.push("/")},children:[(0,i.jsx)(u.Z,{className:"mr-[6px]"}),"返回"]})}):null,null==e?void 0:e.children]},"main"),(0,i.jsx)(h.default,{children:(null==e?void 0:e.goToTop)&&"object"==typeof document?(0,s.createPortal)((0,i.jsx)(f,{type:"primary",icon:(0,i.jsx)(o.Z,{}),title:"返回顶部",tabIndex:0,role:"button","aria-label":"返回顶部"}),document.body):null},"backTop")]}m.propTypes={children:a().node,goToTop:a().bool,goBack:a().bool},n.Z=m},43221:function(e,n,t){"use strict";var i=t(85893),s=t(41664),r=t.n(s),a=t(21612),l=t(78957),d=t(83062),c=t(67337),o=t(32958),u=t.n(o),h=t(90791),p=t(39182);let x=["github.io","vercel.app"],f=[{href:"/",title:"文章"},{href:"/favorites",title:"收藏夹"},{href:"/project",title:"开源项目"}].map((e,n)=>(0,i.jsx)("li",{className:u().navListItem,children:(0,i.jsx)(r(),{href:e.href,children:e.title})},e.href));n.Z=function(e){return(0,i.jsx)(a.Z.Header,{className:u().antdHeader,children:(0,i.jsxs)("div",{className:u().header,children:[(0,i.jsx)("nav",{className:u().headerLeft,children:(0,i.jsx)("ul",{className:u().navList,children:f})}),(0,i.jsx)("div",{className:u().headerRight,children:(0,i.jsxs)(l.Z,{size:16,children:[(0,i.jsx)(d.Z,{title:"切换网站地址",children:(0,i.jsx)("a",{className:u().switchAddress,role:"button",tabIndex:0,"aria-label":"切换网站地址",onClick:function(e){let{pathname:n,hostname:t}=window.location,i=/github\.io/.test(t);window.location.href=new URL(n,"https://duan602728596.".concat(x[i?1:0],"/"))},children:(0,i.jsx)(c.Z,{className:u().switchAddressIcon})})}),(0,i.jsx)(p.Z,{className:u().githubLink,href:"https://github.com/duan602728596",children:(0,i.jsx)(h.Z,{className:"block w-full h-full",imageClassName:"block w-full h-full",avifSrc:"/images/github.avif",webpSrc:"/images/github.webp",src:"/images/github.png",alt:"github"})})]})})]})})}},90791:function(e,n,t){"use strict";var i=t(85893),s=t(45697),r=t.n(s);function a(e){let{className:n,imageClassName:t,avifSrc:s,webpSrc:r,src:a,alt:l}=e;return(0,i.jsxs)("picture",{className:n,children:[s&&(0,i.jsx)("source",{srcSet:s,type:"image/avif"}),r&&(0,i.jsx)("source",{srcSet:r,type:"image/webp"}),(0,i.jsx)("img",{className:t,src:a,alt:l})]})}a.propTypes={className:r().string,imageClassName:r().string,avifSrc:r().string,webpSrc:r().string,src:r().string},n.Z=a},30673:function(e,n,t){"use strict";var i=t(85893),s=t(67294),r=t(45697),a=t.n(r),l=t(43221),d=t(99388);function c(e){return(0,i.jsxs)(s.Fragment,{children:[(0,i.jsx)(l.Z,{}),(0,i.jsx)(d.Z,{goToTop:!0,goBack:!0,children:e.children})]})}c.propTypes={children:a().node},n.Z=c},63791:function(e){e.exports={main:"main_main__IZXSv",goToTop:"main_goToTop__Py8c8"}},32958:function(e){e.exports={antdHeader:"nav_antdHeader__eCvl0",header:"nav_header__y1mlw",headerLeft:"nav_headerLeft__PrT7_",headerRight:"nav_headerRight__JfqYP",navList:"nav_navList__3HXot",navListItem:"nav_navListItem__hpAdz",switchAddress:"nav_switchAddress__sVzqD",githubLink:"nav_githubLink__BDzSl",switchAddressIcon:"nav_switchAddressIcon__KLxGG"}}},function(e){e.O(0,[932,1447,4530,3791,9036,8791,6675,2888,9774,179],function(){return e(e.s=47727)}),_N_E=e.O()}]);